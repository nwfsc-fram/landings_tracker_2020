---
title: "Outlier Analysis"
output: word_document
---

```{r setup, include=FALSE}
library(dplyr)
library(reshape2)
library(lubridate)
library(ggplot2)

source("C:/Program Files/R/connectioninfoROracle.r")

# Deflator #####
# Currently coded to treat 2020 as 2019$
defl <- dbGetQuery(framdw, paste("select year, defl2019/100 as defl from fram_analysis.edc_gdp_defl"))
defl2020 <- filter(defl, YEAR == 2019) %>%
  mutate(YEAR = 2020)
defl_adj <- rbind(defl, defl2020)

# Load data from data_pull.R ####
comp_dat_raw <- readRDS('comp_dat_raw.RDS') %>%
  rename(YEAR = LANDING_YEAR) %>%
  mutate(price = EXVESSEL_REVENUE/(ROUND_WEIGHT_MTONS*2204.62)) %>%
  group_by(SPECIES_GROUP, AGENCY_CODE, LANDING_MONTH, YEAR) %>%
  mutate(monthly_rev = sum(EXVESSEL_REVENUE),
         monthly_mt = sum(ROUND_WEIGHT_MTONS)) %>%
  mutate(per_rev = round((EXVESSEL_REVENUE/monthly_rev)*100, 2),
         per_mt = round((ROUND_WEIGHT_MTONS/monthly_mt)*100,2),
         lbs = (ROUND_WEIGHT_MTONS*2204.62))

comp_dat_adj <- comp_dat_raw %>%
  filter(price < 200)
```

## Overview
There are a four data points from 2017-2020 that look like obvious errors (one instance of crab in 2018, crab in 2020, shrimp in 2017, and other in 2018). Removing prices > $150/lb from comp_dat_raw, or bounding them would deal with them. See below for outlier analysis.

## Broad Look
These graphs take a very high level look at all the data together. As you can see, there are several fairly obvious outliers in the crab in 2018 and 2020, and maybe some in shrimp and other over the years. So I start by removing prices > $200/lb. 


```{r boxplot_all, echo = F}
ggplot(comp_dat_raw, aes(x = SPECIES_GROUP, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))  

```

```{r scatter_all, echo = F}
ggplot(comp_dat_raw, aes(x=LANDING_DATE, y=price)) + geom_point()

```


## 2020 
I take a look at 2020 data to see if we observe any outliers in terms of ex-vessel price and compare that with how "important" each observation is to monthly ex-vessel revenue by state. Once the prices > $200/lb are removed - I don't see any 2020 observations that look like obvious errors that would have large impact on our data. 

```{r scatter_2020, echo = F}
ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'CRAB'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Crab") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'SHRIMP'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Shrimp") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'NON-WHITING GROUNDFISH'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Non-whiting Groundfish") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'SALMON'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Salmon") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'TUNA'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Tuna") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'WHITING'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Whiting") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'SHELLFISH'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Shellfish") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR == 2020, SPECIES_GROUP == 'OTHER'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Other") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)
```

## All Years
Doing the same exercise for all years, the only observation that looks potentially problematic is the shrimp price over $150/lb. 
```{r scatter_allyears, echo = F}
ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'CRAB'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Crab") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'SHRIMP'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Shrimp") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'NON-WHITING GROUNDFISH'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Non-whiting Groundfish") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'SALMON'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Salmon") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'TUNA'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Tuna") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'WHITING'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Whiting") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'SHELLFISH'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Shellfish") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)

ggplot(comp_dat_adj %>% 
         filter(YEAR < 2020, SPECIES_GROUP == 'OTHER'), aes(x = per_rev, y = price)) +
 geom_point() + 
   ggtitle("Other") + xlab("% of Monthly Revenue (0-100)") + ylab("Ex-vessel price (2019 $/lb)") +
  facet_grid(.~AGENCY_CODE)
```


## By Fishery over Time

```{r boxplot_byfishery, echo = F}

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'CRAB'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Crab")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'NON-WHITING GROUNDFISH'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Non-whiting Groundfish")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'SALMON'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Salmon")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'SHRIMP'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Shrimp")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'WHITING'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Whiting")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'OTHER'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Other")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'COASTAL PELAGIC'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Coastal pelagics")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'TUNA'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Tuna")

ggplot(comp_dat_adj %>% filter(SPECIES_GROUP == 'SHELLFISH'), aes(group = YEAR, x = YEAR, y = price)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + ggtitle("Shellfish")


```

